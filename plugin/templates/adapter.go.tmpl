// Package adapter contains auto-generated gRPC service adapter
// Generated from protobuf annotations - DO NOT EDIT
package adapter

import (
{{- range .PackageImports }}
	"{{.}}"
{{- end }}
{{- if .ProtobufPackage }}
	{{.ProtobufAlias}} "{{.ProtobufPackage}}"
{{- end }}
)

{{- range .Services }}
{{- $serviceName := .Name }}

// {{.Name}}Adapter adapts models.{{.Name}} to gRPC pb.{{.Name}}Server
type {{.Name}}Adapter struct {
	pb.Unimplemented{{.Name}}Server
	service models.{{.Name}}
}

// New{{.Name}}Adapter creates a new {{.Name}}Adapter
func New{{.Name}}Adapter(service models.{{.Name}}) *{{.Name}}Adapter {
	return &{{.Name}}Adapter{
		service: service,
	}
}

{{- range .Methods }}

{{- if .IsStreaming }}
{{- if and .ClientStream .ServerStream }}
// {{.Name}} implements bidirectional streaming RPC
func (a *{{$serviceName}}Adapter) {{.Name}}(stream pb.{{$serviceName}}_{{.Name}}Server) error {
	ctx := stream.Context()
	
	// Collect input stream into slice
	var inputs []models.{{.InputType}}
	for {
		req, err := stream.Recv()
		if err == io.EOF {
			break
		}
		if err != nil {
			return err
		}
		inputs = append(inputs, {{.InputType}}FromProto(req))
	}
	
	// Call service method
	results, err := a.service.{{.Name}}(ctx, inputs)
	if err != nil {
		return err
	}
	
	// Send all results
	for _, item := range results {
		if err := stream.Send({{.OutputType}}ToProto(item)); err != nil {
			return err
		}
	}
	
	return nil
}

{{- else if .ClientStream }}
// {{.Name}} implements client streaming RPC
func (a *{{$serviceName}}Adapter) {{.Name}}(stream pb.{{$serviceName}}_{{.Name}}Server) error {
	ctx := stream.Context()
	
	// Collect input stream into slice
	var inputs []models.{{.InputType}}
	for {
		req, err := stream.Recv()
		if err == io.EOF {
			break
		}
		if err != nil {
			return err
		}
		inputs = append(inputs, {{.InputType}}FromProto(req))
	}
	
	// Call service method
	result, err := a.service.{{.Name}}(ctx, inputs)
	if err != nil {
		return err
	}
	
	// Send response
	return stream.SendAndClose({{.OutputType}}ToProto(result))
}

{{- else }}
// {{.Name}} implements server streaming RPC
func (a *{{$serviceName}}Adapter) {{.Name}}(req *pb.{{.InputType}}, stream pb.{{$serviceName}}_{{.Name}}Server) error {
	// Convert request and call service
	goReq := {{.InputType}}FromProto(req)
	ctx := stream.Context()
	results, err := a.service.{{.Name}}(ctx, goReq)
	if err != nil {
		return err
	}
	
	// Stream responses to client
	for _, item := range results {
		if err := stream.Send({{.OutputType}}ToProto(item)); err != nil {
			return err
		}
	}
	
	return nil
}
{{- end }}

{{- else }}
// {{.Name}} implements unary RPC
func (a *{{$serviceName}}Adapter) {{.Name}}(ctx context.Context, req {{protobufTypeName .InputType}}) ({{protobufTypeName .OutputType}}, error) {
	// Convert request from protobuf to original Go type
{{- if eq .InputType "google.protobuf.Empty" }}
	// No input parameters needed
{{- else if hasPrefix .InputType "google.protobuf." }}
	{{- if eq .InputType "google.protobuf.Int64Value" }}
	goReq := req.Value  // Extract int64 from wrapper
	{{- else if eq .InputType "google.protobuf.Int32Value" }}
	goReq := req.Value  // Extract int32 from wrapper
	{{- else if eq .InputType "google.protobuf.StringValue" }}
	goReq := req.Value  // Extract string from wrapper
	{{- else if eq .InputType "google.protobuf.BoolValue" }}
	goReq := req.Value  // Extract bool from wrapper
	{{- else if eq .InputType "google.protobuf.DoubleValue" }}
	goReq := req.Value  // Extract float64 from wrapper
	{{- else if eq .InputType "google.protobuf.FloatValue" }}
	goReq := req.Value  // Extract float32 from wrapper
	{{- else if eq .InputType "google.protobuf.UInt64Value" }}
	goReq := req.Value  // Extract uint64 from wrapper
	{{- else if eq .InputType "google.protobuf.UInt32Value" }}
	goReq := req.Value  // Extract uint32 from wrapper
	{{- else if eq .InputType "google.protobuf.BytesValue" }}
	goReq := req.Value  // Extract []byte from wrapper
	{{- else }}
	{{- if hasPrefix .OriginalInputType "*" }}
	goReqValue := {{.InputType}}FromProto(req)
	goReq := &goReqValue
	{{- else }}
	goReq := {{.InputType}}FromProto(req)
	{{- end }}
	{{- end }}
{{- else }}
	{{- if hasPrefix .OriginalInputType "*" }}
	goReqValue := {{.InputType}}FromProto(req)
	goReq := &goReqValue
	{{- else }}
	goReq := {{.InputType}}FromProto(req)
	{{- end }}
{{- end }}
	
	// Call service method with original signature
{{- if eq .OutputType "google.protobuf.Empty" }}
	err := a.service.{{.Name}}({{if .HasContext}}ctx{{if ne .InputType "google.protobuf.Empty"}}, {{end}}{{end}}{{if ne .InputType "google.protobuf.Empty"}}goReq{{end}})
	if err != nil {
		return nil, err
	}
	return &emptypb.Empty{}, nil
{{- else }}
	result, err := a.service.{{.Name}}({{if .HasContext}}ctx{{if ne .InputType "google.protobuf.Empty"}}, {{end}}{{end}}{{if ne .InputType "google.protobuf.Empty"}}goReq{{end}})
	if err != nil {
		return nil, err
	}
	
	// Convert result to protobuf type
{{- if hasPrefix .OutputType "google.protobuf." }}
	{{- if eq .OutputType "google.protobuf.Int64Value" }}
	return &wrapperspb.Int64Value{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.Int32Value" }}
	return &wrapperspb.Int32Value{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.StringValue" }}
	return &wrapperspb.StringValue{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.BoolValue" }}
	return &wrapperspb.BoolValue{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.DoubleValue" }}
	return &wrapperspb.DoubleValue{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.FloatValue" }}
	return &wrapperspb.FloatValue{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.UInt64Value" }}
	return &wrapperspb.UInt64Value{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.UInt32Value" }}
	return &wrapperspb.UInt32Value{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else if eq .OutputType "google.protobuf.BytesValue" }}
	return &wrapperspb.BytesValue{Value: {{if hasPrefix .OriginalOutputType "*"}}*{{end}}result}, nil
	{{- else }}
	return {{.OutputType}}ToProto({{if hasPrefix .OriginalOutputType "*"}}*{{end}}result), nil
	{{- end }}
{{- else }}
	return {{.OutputType}}ToProto({{if hasPrefix .OriginalOutputType "*"}}*{{end}}result), nil
{{- end }}
{{- end }}
}
{{- end }}

{{- end }}
{{- end }}